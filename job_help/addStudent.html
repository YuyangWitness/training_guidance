<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.min.css" rel="stylesheet" />
		<script type="text/javascript" src="js/angular.min.js" ></script>
	    <script type="text/javascript" src="js/login.js" ></script>
	</head>
    <style>    	
			#add {
				padding: 10px;
			}
    </style>
	<body ng-app="app">
		<script src="js/mui.min.js"></script>
		<script type="text/javascript">
			mui.init()
		</script>
		<header class="mui-bar mui-bar-nav">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		    <h1 class="mui-title">添加学生</h1>
		</header>
		<div class="mui-content" ng-controller="addController">
		    		<form class="mui-input-group">
		    			<div class="mui-input-row">
		    				<label>用户名</label>
		    				<input type="text" class="mui-input-clear" placeholder="请输入用户名" id="username"/>
		    			</div>
		    			<div class="mui-input-row">
		    				<label>姓名</label>
		    				<input type="text" class="mui-input-clear" placeholder="请输入姓名" id="name"/>
		    			</div>
		    			<div class="mui-input-row">
		    				<label>部门科室</label>
		    				<select id='department' ng-model="selected"  ng-options="(m.apartment + '-' + m.department) group by m.apartment for m in model">		    				
		    				</select>		  
		    			</div>
		    			
		    		</form>
              <form>
				<div class="mui-content-padded">
					<button class="mui-btn mui-btn-primary mui-btn-block" id="add">添加学生</button>
				</div>
			</form>
			
		</div>
	</body>
    <script>
   
    var app = angular.module('app',[]);
    app.controller('addController',function($scope){
    	$scope.selected='';
    	$scope.model =[{
    		department:'科室一',
    		apartment:'应用系统一部'
    	},{
    		department:'科室二',
    		apartment:'应用系统一部'
    	},{
    		department:'薪酬室',
    		apartment:'人力资源部'
    	},{
    		department:'员工管理室',
    		apartment:'人力资源部'
    	}]
    });
     mui.plusReady(function(){
    function createTable(database){
    		database.transaction(function(tx){
    		tx.executeSql(
    			"create table if not exists student(id TEXT,name TEXT,username TEXT,password TEXT,department TEXT,director TEXT)",
    			[],
    			function(tx,result){},
    			function(tx,error){
    				alert('创建表格失败');
    			}
    		);
    	});
    }
    
    function insert(database,stu){
    	database.transaction(function(tx){
    		tx.executeSql(
    			"insert into student(id,name,username,password,department,director) values(?,?,?,?,?,?)",
    			[stu.id,stu.name,stu.username,'1234567',stu.department,stu.director],
    			function(){
    				plus.nativeUI.toast('添加成功');
    			},
    			function(tx,error){
    				plus.nativeUI.toast('添加失败');
    			}
    	);
    	});
    }
    
    function selectUser(database,stu){
    	database.transaction(function(tx){
    		tx.executeSql(
    			"select * from student where username = ?",[stu.username],
    			function(tx,result){
    				if(result.rows.length==0){
    					insert(database,stu);
    					 mui.back();
    				}else{
    					alert('用户名已经被注册，请重新填写');
    				}
    			},function(){
    				alert('select is fail')
    			}
    		);
    	});
    }
    var add = document.getElementById('add');
    
    add.addEventListener('tap',function(){
    	var director = getstate().account;
    	var username = document.getElementById('username');
    var name = document.getElementById('name');
    var department = document.getElementById('department');
    var depatVal = department.options[department.options.selectedIndex].innerText;
    var id = Math.round(Math.random()*1000);
    var stu = {
    	    id:id,
    	    username:username.value,
    	    name:name.value,
    	    department:depatVal,
    	    director:director
    }
    	    var database = openDatabase('train','1.0','培训数据库',1024*1024,function(){});
    	    if(!database){
    	    	alert('数据库创建失败，添加失败')
    	    }
    	    createTable(database);
    	    selectUser(database,stu);
    	    
    	  	
    	
    	    
    });
});    
    </script>
</html>